<!DOCTYPE html>
<html lang="ar">
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <title>Bandler â€” Real Solana Bulk Trader v4.0</title>
    
    <!-- Ù…ÙƒØªØ¨Ø§Øª Solana Ø§Ù„Ø­Ù‚ÙŠÙ‚ÙŠØ© -->
    <script src="https://unpkg.com/@solana/web3.js@latest/lib/index.iife.js"></script>
    <script src="https://unpkg.com/@solana/spl-token@latest/lib/index.iife.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
    <script src="https://unpkg.com/@project-serum/anchor@0.26.0"></script>
    <!-- Ù…ÙƒØªØ¨Ø© Raydium SDK -->
    <script src="https://cdn.jsdelivr.net/npm/@raydium-io/raydium-sdk@2.0.12/lib/index.iife.js"></script>
    
    <style>
        :root {
            --bg: #070617;
            --card: rgba(255,255,255,0.03);
            --accent-start: #06b6d4;
            --accent-end: #7c3aed;
            --success: #10b981;
            --warning: #f59e0b;
            --danger: #ef4444;
            --muted: rgba(230,238,248,0.65);
            --raydium: #00d2ff;
            --pumpfun: #ff6b6b;
            --jupiter: #8b5cf6;
        }
        
        * { box-sizing: border-box; margin: 0; padding: 0; }
        
        body {
            font-family: 'Segoe UI', Tahoma, Arial, sans-serif;
            background: radial-gradient(circle at 10% 10%, #071027 0%, #0b0b14 40%, #070617 100%);
            color: #e6eef8;
            direction: rtl;
            padding: 15px;
            line-height: 1.5;
            font-size: 14px;
        }
        
        .app { max-width: 100%; margin: 0 auto; }
        
        .mobile-warning {
            background: linear-gradient(90deg, #f59e0b, #d97706);
            padding: 12px;
            border-radius: 8px;
            margin-bottom: 15px;
            text-align: center;
            font-size: 13px;
        }
        
        header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            gap: 15px;
            margin-bottom: 15px;
            flex-wrap: wrap;
        }
        
        .brand {
            display: flex;
            gap: 10px;
            align-items: center;
        }
        
        .logo {
            width: 45px;
            height: 45px;
            border-radius: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 800;
            background: linear-gradient(135deg, #0ea5e9, #7c3aed);
            box-shadow: 0 8px 30px rgba(59,130,246,0.12);
            font-size: 18px;
        }
        
        .title h1 { margin: 0; font-size: 18px; }
        .title .sub { font-size: 11px; color: var(--muted); }
        
        .card {
            background: linear-gradient(180deg, rgba(255,255,255,0.02), rgba(255,255,255,0.01));
            border-radius: 10px;
            padding: 15px;
            border: 1px solid rgba(255,255,255,0.04);
            box-shadow: 0 4px 15px rgba(2,6,23,0.6);
            margin-bottom: 12px;
        }
        
        .card.selected-group {
            border-color: #06b6d4;
            background: linear-gradient(135deg, rgba(6, 182, 212, 0.1), rgba(124, 58, 237, 0.05));
            box-shadow: 0 0 15px rgba(6, 182, 212, 0.3);
        }
        
        .row { display: flex; gap: 12px; align-items: center; flex-wrap: wrap; }
        .col { flex: 1; min-width: 120px; }
        
        button {
            background: linear-gradient(90deg, var(--accent-start), var(--accent-end));
            border: none;
            color: white;
            padding: 10px 12px;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 600;
            box-shadow: 0 4px 12px rgba(7,10,30,0.6);
            transition: all 0.3s ease;
            font-size: 13px;
            flex: 1;
            min-width: 80px;
        }
        
        button:active { transform: translateY(1px); }
        
        button.ghost {
            background: transparent;
            border: 1px solid rgba(255,255,255,0.06);
        }
        
        button.success { background: linear-gradient(90deg, var(--success), #059669); }
        button.danger { background: linear-gradient(90deg, var(--danger), #dc2626); }
        button.warning { background: linear-gradient(90deg, var(--warning), #d97706); }
        button.raydium { background: linear-gradient(90deg, var(--raydium), #0099cc); }
        button.pumpfun { background: linear-gradient(90deg, var(--pumpfun), #cc5555); }
        button.jupiter { background: linear-gradient(90deg, var(--jupiter), #6d28d9); }
        
        .mobile-buttons {
            display: flex;
            gap: 6px;
            flex-wrap: wrap;
        }
        
        .mobile-buttons button {
            flex: 1;
            min-width: 70px;
            font-size: 12px;
            padding: 8px 10px;
        }
        
        .dex-selector {
            display: flex;
            gap: 6px;
            margin-bottom: 12px;
            flex-wrap: wrap;
        }
        
        .dex-btn {
            flex: 1;
            min-width: 90px;
            background: rgba(255,255,255,0.05);
            border: 1px solid rgba(255,255,255,0.1);
            font-size: 12px;
            padding: 8px 10px;
        }
        
        .dex-btn.active {
            background: linear-gradient(90deg, var(--accent-start), var(--accent-end));
            border-color: transparent;
        }
        
        input, select, textarea {
            background: rgba(0,0,0,0.35);
            border: 1px solid rgba(255,255,255,0.04);
            padding: 10px;
            border-radius: 6px;
            color: #e6eef8;
            width: 100%;
            font-size: 14px;
        }
        
        .tiny { font-size: 11px; color: var(--muted); }
        .muted { color: var(--muted); }
        .addr { font-family: monospace; color: #9be7c4; word-break: break-all; font-size: 11px; }
        
        .flex-between { 
            display: flex; 
            justify-content: space-between; 
            align-items: center; 
            flex-wrap: wrap; 
            gap: 8px; 
        }
        
        .badge {
            padding: 6px 10px;
            border-radius: 6px;
            font-weight: 700;
            color: #071027;
            background: linear-gradient(90deg, #ddd, #fff);
            font-size: 11px;
        }
        
        .log {
            font-family: monospace;
            font-size: 11px;
            max-height: 200px;
            overflow: auto;
            padding: 10px;
            background: rgba(0,0,0,0.35);
            border-radius: 6px;
            line-height: 1.4;
        }
        
        .section-title {
            font-weight: 800;
            color: #a5f3fc;
            margin-bottom: 10px;
            font-size: 14px;
        }
        
        .wallet-list {
            max-height: 200px;
            overflow: auto;
            border-radius: 6px;
            padding: 10px;
            background: linear-gradient(180deg, rgba(255,255,255,0.01), transparent);
        }
        
        .wallet-item {
            display: flex;
            gap: 8px;
            align-items: center;
            padding: 8px;
            border-radius: 6px;
            border: 1px solid rgba(255,255,255,0.02);
            margin-bottom: 6px;
            flex-wrap: wrap;
            font-size: 11px;
        }
        
        .progress-bar {
            width: 100%;
            height: 6px;
            background: rgba(255,255,255,0.05);
            border-radius: 3px;
            overflow: hidden;
            margin-top: 10px;
        }
        
        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, var(--accent-start), var(--accent-end));
            transition: width 0.3s ease;
        }
        
        .security-warning {
            background: rgba(239,68,68,0.1);
            border: 1px solid rgba(239,68,68,0.3);
            padding: 10px;
            border-radius: 6px;
            margin: 10px 0;
            font-size: 11px;
        }
        
        .net-ind {
            display: inline-block;
            width: 8px;
            height: 8px;
            border-radius: 50%;
            margin-left: 6px;
        }
        
        .private-key {
            background: rgba(0,0,0,0.5);
            padding: 8px;
            border-radius: 4px;
            margin: 4px 0;
            font-family: monospace;
            font-size: 10px;
            word-break: break-all;
            border: 1px solid rgba(239,68,68,0.3);
        }
        
        .download-btn {
            background: linear-gradient(90deg, #8b5cf6, #7c3aed);
            font-size: 10px;
            padding: 6px 8px;
        }

        .small-input-group {
            display: flex;
            gap: 8px;
            align-items: center;
        }
        
        .small-input-group button {
            padding: 6px 10px;
            font-size: 12px;
        }

        @media (max-width: 480px) {
            body { padding: 10px; }
            .card { padding: 12px; }
            button { padding: 8px 10px; font-size: 12px; }
            .title h1 { font-size: 16px; }
            .section-title { font-size: 13px; }
        }
    </style>
</head>
<body>
    <div class="app">
        <div class="mobile-warning">
            ğŸ“± **ØªÙ†Ø¨ÙŠÙ‡:** Ù„Ù„ØªØ¯Ø§ÙˆÙ„ Ø§Ù„Ø­Ù‚ÙŠÙ‚ÙŠØŒ ØªØ£ÙƒØ¯ Ù…Ù† Ø§Ø³ØªØ®Ø¯Ø§Ù… Mainnet ÙˆØ£Ù…ÙˆØ§Ù„ Ø­Ù‚ÙŠÙ‚ÙŠØ©
        </div>

        <header>
            <div class="brand">
                <div class="logo">B</div>
                <div class="title">
                    <h1>Bandler â€” Real Bulk Trader v4.0</h1>
                    <div class="sub">Real Trading: Raydium, Pump.fun, Jupiter, DexScreener</div>
                </div>
            </div>

            <div class="controls">
                <div style="display:flex;align-items:center;gap:6px">
                    <select id="networkSelect" onchange="changeNetwork()" style="font-size:12px; padding:8px;">
                        <option value="mainnet-beta">Mainnet</option>
                        <option value="devnet">Devnet</option>
                        <option value="testnet">Testnet</option>
                    </select>
                    <div id="networkBadge" class="badge">
                        <span id="netDot" class="net-ind" style="background:#16a34a"></span>
                        <span id="networkLabel">Mainnet</span>
                    </div>
                </div>
            </div>
        </header>

        <!-- Ø§ØªØµØ§Ù„ Ø§Ù„Ù…Ø­ÙØ¸Ø© Ø§Ù„Ø­Ù‚ÙŠÙ‚ÙŠ -->
        <section class="card">
            <div class="section-title">ğŸ”— Ø§ØªØµØ§Ù„ Ù…Ø­ÙØ¸Ø© Phantom Ø§Ù„Ø­Ù‚ÙŠÙ‚ÙŠ</div>
            <div class="row">
                <div class="col">
                    <div class="tiny">Ø§Ù„Ù…Ø­ÙØ¸Ø© Ø§Ù„Ù…ØªØµÙ„Ø©:</div>
                    <div id="connectedAddress" class="muted">-</div>
                    <div class="tiny" style="margin-top:8px">Ø±ØµÙŠØ¯ Phantom:</div>
                    <div id="phantomBalance" class="muted">-</div>
                </div>
                <div class="col">
                    <div class="tiny">Ù…Ø­ÙØ¸Ø© Ø§Ù„Ù…Ø§Ø³ØªØ±:</div>
                    <div id="masterWalletAddress" class="addr">Ù„Ù… ÙŠØªÙ… Ø§Ù„Ø¥Ù†Ø´Ø§Ø¡</div>
                    <div id="masterWalletBalance" class="muted">Ø±ØµÙŠØ¯: 0 SOL</div>
                </div>
            </div>
            <div class="mobile-buttons" style="margin-top:10px">
                <button id="connectBtn" onclick="connectRealWallet()">Ø§ØªØµØ§Ù„ Ø¨Ù€ Phantom</button>
                <button id="disconnectBtn" class="ghost" style="display:none" onclick="disconnectWallet()">ÙØµÙ„</button>
                <button onclick="generateMasterWallet()">Ù…Ø­ÙØ¸Ø© Ù…Ø§Ø³ØªØ±</button>
            </div>
            
            <div class="row" style="margin-top:10px">
                <div class="col">
                    <div class="small-input-group">
                        <input id="fundMasterAmount" placeholder="Ù…Ù‚Ø¯Ø§Ø± SOL Ù„Ù„Ø¥Ø¶Ø§ÙØ©" type="number" step="0.0001"/>
                        <button onclick="fundMasterWallet()">Ø£Ø¶Ù SOL</button>
                    </div>
                </div>
                <div class="col">
                    <div class="small-input-group">
                        <input id="withdrawToPhantomAmount" placeholder="Ø³Ø­Ø¨ Ø¥Ù„Ù‰ Phantom" />
                        <button onclick="document.getElementById('withdrawToPhantomAmount').value='all'">Max</button>
                        <button onclick="withdrawToPhantom()">Ø³Ø­Ø¨</button>
                    </div>
                </div>
            </div>
        </section>

        <!-- Ù†Ø¸Ø§Ù… Ø§Ù„Ù…Ø­Ø§ÙØ¸ ÙˆØ§Ù„Ù…Ø¬Ù…ÙˆØ¹Ø§Øª Ø§Ù„Ø­Ù‚ÙŠÙ‚ÙŠ -->
        <section class="card">
            <div class="section-title">ğŸ‘¥ ØªÙˆÙ„ÙŠØ¯ Ø§Ù„Ù…Ø­Ø§ÙØ¸ ÙˆØ§Ù„Ù…Ø¬Ù…ÙˆØ¹Ø§Øª (20 Ù…Ø¬Ù…ÙˆØ¹Ø© ÙƒØ­Ø¯ Ø£Ù‚ØµÙ‰)</div>
            <div class="security-warning">
                âš ï¸ Ø³ÙŠØªÙ… ØªÙˆÙ„ÙŠØ¯ Ù…Ø­Ø§ÙØ¸ Ø­Ù‚ÙŠÙ‚ÙŠØ© Ù…Ø¹ Private Keys - Ø§Ø­ÙØ¸Ù‡Ø§ Ø¨Ø£Ù…Ø§Ù†!
            </div>
            <div class="row">
                <div class="col">
                    <div class="tiny">Ø¹Ø¯Ø¯ Ø§Ù„Ù…Ø­Ø§ÙØ¸ (1-200)</div>
                    <input id="walletCountInput" type="number" min="1" max="200" value="10" style="font-size:12px;"/>
                </div>
                <div class="col">
                    <div class="tiny">Ù…Ø­Ø§ÙØ¸ ÙÙŠ ÙƒÙ„ Ù…Ø¬Ù…ÙˆØ¹Ø©</div>
                    <input id="walletsPerGroup" type="number" min="1" value="20" style="font-size:12px;"/>
                </div>
                <div class="col">
                    <div class="tiny">SOL Ù„ÙƒÙ„ Ù…Ø­ÙØ¸Ø©</div>
                    <input id="solPerWallet" type="number" step="0.0001" value="0.01" style="font-size:12px;"/>
                </div>
            </div>
            <div class="row" style="margin-top:10px">
                <div class="col">
                    <div class="tiny">Ù†ÙˆØ¹ Ø§Ù„ØªÙˆØ²ÙŠØ¹</div>
                    <select id="distributionType" style="font-size:12px;">
                        <option value="equal">Ù…ØªØ³Ø§ÙˆÙ</option>
                        <option value="random">Ø¹Ø´ÙˆØ§Ø¦ÙŠ</option>
                    </select>
                </div>
                <div class="col">
                    <div style="margin-top:20px"></div>
                    <button onclick="generateWalletsFromInput()">ØªÙˆÙ„ÙŠØ¯ Ø§Ù„Ù…Ø­Ø§ÙØ¸</button>
                </div>
            </div>
            <div class="mobile-buttons" style="margin-top:10px">
                <button onclick="fundAllGroups()">ØªÙ…ÙˆÙŠÙ„ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹Ø§Øª</button>
                <button onclick="downloadPrivateKeys()" class="download-btn">ØªØ­Ù…ÙŠÙ„ Private Keys</button>
            </div>
        </section>

        <!-- Ø¹Ø±Ø¶ Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹Ø§Øª -->
        <section class="card">
            <div class="section-title">ğŸ“¦ Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹Ø§Øª ÙˆØ§Ù„Ù…Ø­Ø§ÙØ¸ â€” Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø£Ø±Ø¨Ø§Ø­/Ø§Ù„Ø®Ø³Ø§Ø¦Ø±: <span id="globalPnL" style="color:#00ff00;">--</span> SOL</div>
            <div id="groupsContainer"></div>
        </section>

        <!-- Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„ØªÙˆÙƒÙ† Ø§Ù„Ø­Ù‚ÙŠÙ‚ÙŠØ© -->
        <section class="card">
            <div class="section-title">ğŸ” Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„ØªÙˆÙƒÙ† Ø§Ù„Ø­Ù‚ÙŠÙ‚ÙŠ - DexScreener</div>
            <div class="row">
                <div class="col">
                    <input id="tokenAddress" placeholder="Ø£Ø¯Ø®Ù„ Ø¹Ù†ÙˆØ§Ù† Ø§Ù„ØªÙˆÙƒÙ† Ø§Ù„Ø­Ù‚ÙŠÙ‚ÙŠ" style="font-size:12px;"/>
                </div>
                <div style="width:120px">
                    <button onclick="getRealTokenInfo()" style="font-size:12px;">Ø¬Ù„Ø¨ Ø§Ù„Ù…Ø¹Ù„ÙˆÙ…Ø§Øª</button>
                </div>
            </div>
            <div id="tokenInfoArea" style="margin-top:10px;"></div>
        </section>

        <!-- Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„ØªØ¯Ø§ÙˆÙ„ -->
        <section class="card">
            <div class="section-title">âš¡ Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„ØªØ¯Ø§ÙˆÙ„ Ø§Ù„Ø­Ù‚ÙŠÙ‚ÙŠ</div>
            <div class="dex-selector">
                <button class="dex-btn jupiter active" onclick="selectDex('jupiter')">Jupiter</button>
                <button class="dex-btn raydium" onclick="selectDex('raydium')">Raydium</button>
                <button class="dex-btn pumpfun" onclick="selectDex('pumpfun')">Pump.fun</button>
            </div>
            
            <div class="row">
                <div class="col">
                    <div class="tiny">Ø§Ù†Ø²Ù„Ø§Ù‚ (Slippage %)</div>
                    <div class="small-input-group">
                        <input id="slippage" type="number" value="5" min="0" max="100" style="font-size:12px;"/>
                        <button onclick="document.getElementById('slippage').value='auto'" style="font-size:11px;">ØªÙ„Ù‚Ø§Ø¦ÙŠ</button>
                    </div>
                </div>
                <div class="col">
                    <div class="tiny">Ø£Ù‚ØµÙ‰ Ø±Ø³ÙˆÙ… ØºØ§Ø² (SOL)</div>
                    <input id="maxGasFee" type="number" step="0.000001" value="0.0005" style="font-size:12px;"/>
                </div>
            </div>
        </section>

        <!-- Ø§Ù„ØªØ¯Ø§ÙˆÙ„ Ø§Ù„ÙØ±Ø¯ÙŠ ÙˆØ§Ù„Ø¬Ù…Ø§Ø¹ÙŠ -->
        <section class="card">
            <div class="section-title">ğŸ›’ Ø§Ù„ØªØ¯Ø§ÙˆÙ„ Ø§Ù„Ø­Ù‚ÙŠÙ‚ÙŠ</div>
            <div class="row">
                <div class="col">
                    <div class="tiny">Ù…Ù‚Ø¯Ø§Ø± Ø§Ù„ØªØ¯Ø§ÙˆÙ„ (SOL)</div>
                    <input id="tradeAmount" type="number" value="0.01" min="0.001" step="0.001" style="font-size:12px;"/>
                </div>
                <div class="col">
                    <div class="tiny">Ø¹Ù…Ù„ÙŠØ© Ø§Ù„ØªØ¯Ø§ÙˆÙ„</div>
                    <div class="mobile-buttons">
                        <button class="success" onclick="executeRealTrade('buy')">Ø´Ø±Ø§Ø¡ Ø­Ù‚ÙŠÙ‚ÙŠ</button>
                        <button class="danger" onclick="executeRealTrade('sell')">Ø¨ÙŠØ¹ Ø­Ù‚ÙŠÙ‚ÙŠ</button>
                    </div>
                </div>
            </div>
            
            <div class="row" style="margin-top:10px">
                <div class="col">
                    <div class="tiny">ØªØ¯Ø§ÙˆÙ„ Ø¬Ù…Ø§Ø¹ÙŠ Ø¹Ù„Ù‰ Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹Ø§Øª Ø§Ù„Ù…Ø­Ø¯Ø¯Ø©</div>
                    <input id="bulkAmount" placeholder="Ù…Ù‚Ø¯Ø§Ø± Ø§Ù„ØªØ¯Ø§ÙˆÙ„ Ù„ÙƒÙ„ Ù…Ø­ÙØ¸Ø©" type="number" step="any" style="font-size:12px;"/>
                </div>
                <div class="col">
                    <div class="tiny">Ø§Ù„ØªØ¯Ø§ÙˆÙ„ Ø§Ù„Ø¬Ù…Ø§Ø¹ÙŠ</div>
                    <div class="mobile-buttons">
                        <button onclick="globalTrade('buy')">Ø´Ø±Ø§Ø¡ Ø¬Ù…Ø§Ø¹ÙŠ</button>
                        <button onclick="globalTrade('sell')" style="background:linear-gradient(90deg,#ef4444,#fb923c)">Ø¨ÙŠØ¹ Ø¬Ù…Ø§Ø¹ÙŠ</button>
                    </div>
                </div>
            </div>
            
            <div id="tradeProgress" style="display:none; margin-top:10px">
                <div class="tiny flex-between">
                    <span id="progressText">Ø¬Ø§Ø±ÙŠ Ø§Ù„Ù…Ø¹Ø§Ù„Ø¬Ø©...</span>
                    <span id="progressPercent">0%</span>
                </div>
                <div class="progress-bar">
                    <div id="progressFill" class="progress-fill" style="width:0%"></div>
                </div>
            </div>
        </section>

        <!-- Ø³Ø¬Ù„ Ø§Ù„Ø¹Ù…Ù„ÙŠØ§Øª Ø§Ù„Ø­Ù‚ÙŠÙ‚ÙŠ -->
        <section class="card">
            <div class="section-title">ğŸ“ Ø³Ø¬Ù„ Ø§Ù„Ø¹Ù…Ù„ÙŠØ§Øª Ø§Ù„Ø­ÙŠØ©</div>
            <div id="logArea" class="log"></div>
            <div class="mobile-buttons" style="margin-top:10px">
                <button onclick="clearLog()">Ù…Ø³Ø­ Ø§Ù„Ø³Ø¬Ù„</button>
                <button class="ghost" onclick="downloadLog()">ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø³Ø¬Ù„</button>
                <button onclick="testRealConnection()" class="warning">Ø§Ø®ØªØ¨Ø§Ø± Ø§Ù„Ø§ØªØµØ§Ù„</button>
            </div>
        </section>
    </div>

    <script>
        // Ø§Ù„Ø­Ø§Ù„Ø© Ø§Ù„Ø­Ù‚ÙŠÙ‚ÙŠØ© Ù„Ù„ØªØ·Ø¨ÙŠÙ‚
        let connection = null;
        let wallet = null;
        let walletPublicKey = null;
        let currentNetwork = 'mainnet-beta';
        let currentDex = 'jupiter';
        let currentToken = null;
        let masterWallet = null;
        let walletGroups = [];
        const MAX_WALLETS = 200;
        const MAX_GROUPS = 20;

        // Utilities
        function addToLog(msg){ 
            const log = document.getElementById('logArea'); 
            const t = new Date().toLocaleTimeString('ar-EG'); 
            log.innerHTML += `[${t}] ${msg}<br/>`; 
            log.scrollTop = log.scrollHeight; 
        }

        function resetState(){ 
            wallet=null; 
            connection=null; 
            masterWallet=null; 
            walletGroups=[]; 
            renderGroups(); 
            document.getElementById('connectedAddress').textContent='-'; 
            document.getElementById('phantomBalance').textContent='-'; 
            document.getElementById('masterWalletAddress').textContent='Ù„Ù… ÙŠØªÙ… Ø§Ù„Ø¥Ù†Ø´Ø§Ø¡'; 
            document.getElementById('masterWalletBalance').textContent='Ø±ØµÙŠØ¯: 0 SOL'; 
            document.getElementById('globalPnL').textContent='--'; 
            addToLog('ğŸ§¹ ØªÙ… Ø¥Ø¹Ø§Ø¯Ø© ØªÙ‡ÙŠØ¦Ø© Ø§Ù„Ø­Ø§Ù„Ø©'); 
        }

        // Network handling 
        function updateNetworkBadge(){
            const dot = document.getElementById('netDot');
            const label = document.getElementById('networkLabel');
            if (currentNetwork === 'mainnet-beta'){ 
                dot.style.background='#16a34a'; 
                label.textContent='Mainnet'; 
            } else if (currentNetwork === 'devnet'){ 
                dot.style.background='#8b5cf6'; 
                label.textContent='Devnet'; 
            } else { 
                dot.style.background='#f59e0b'; 
                label.textContent='Testnet'; 
            }
        }

        function changeNetwork(){
            const sel = document.getElementById('networkSelect').value;
            if (sel === currentNetwork) return;
            currentNetwork = sel;
            resetState();
            updateNetworkBadge();
            initApp();
        }

        // Ø§Ù„Ø§ØªØµØ§Ù„ Ø§Ù„Ø­Ù‚ÙŠÙ‚ÙŠ Ø¨Ù…Ø­ÙØ¸Ø© Phantom
        async function connectRealWallet() {
            addToLog('ğŸ”— Ù…Ø­Ø§ÙˆÙ„Ø© Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ù€ Phantom Wallet...');
            
            if (typeof window.solana === 'undefined') {
                if (/Android|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent)) {
                    window.location.href = 'phantom://browse/' + encodeURIComponent(window.location.href);
                    addToLog('ğŸ“² ØªÙ… ÙØªØ­ ØªØ·Ø¨ÙŠÙ‚ Phantom - ÙŠØ±Ø¬Ù‰ Ø§Ù„Ù…ÙˆØ§ÙÙ‚Ø© Ø¹Ù„Ù‰ Ø§Ù„Ø§ØªØµØ§Ù„');
                    return;
                } else {
                    alert('âš ï¸ ÙŠØ±Ø¬Ù‰ ØªØ«Ø¨ÙŠØª Phantom Wallet Ù…Ù† phantom.app');
                    addToLog('âŒ Phantom Wallet ØºÙŠØ± Ù…Ø«Ø¨Øª');
                    return;
                }
            }
            
            try {
                const response = await window.solana.connect({ onlyIfTrusted: false });
                wallet = window.solana;
                walletPublicKey = response.publicKey;
                
                document.getElementById('connectedAddress').textContent = 
                    walletPublicKey.toString().substring(0, 15) + '...';
                document.getElementById('connectBtn').style.display = 'none';
                document.getElementById('disconnectBtn').style.display = 'inline-block';
                
                await updateRealBalance();
                addToLog('âœ… ØªÙ… Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ù€ Phantom Ø¨Ù†Ø¬Ø§Ø­');
                
            } catch (error) {
                addToLog('âŒ ÙØ´Ù„ Ø§Ù„Ø§ØªØµØ§Ù„: ' + error.message);
            }
        }

        async function updateRealBalance() {
            if (!walletPublicKey) return;
            try {
                const balance = await connection.getBalance(walletPublicKey);
                const solBalance = (balance / solanaWeb3.LAMPORTS_PER_SOL).toFixed(6);
                document.getElementById('phantomBalance').textContent = solBalance + ' SOL';
            } catch (error) {
                console.log('Ø®Ø·Ø£ ÙÙŠ Ø¬Ù„Ø¨ Ø§Ù„Ø±ØµÙŠØ¯:', error);
            }
        }

        function disconnectWallet() {
            if (wallet && wallet.disconnect) wallet.disconnect();
            wallet = null;
            walletPublicKey = null;
            
            document.getElementById('connectedAddress').textContent = '-';
            document.getElementById('phantomBalance').textContent = '-';
            document.getElementById('connectBtn').style.display = 'inline-block';
            document.getElementById('disconnectBtn').style.display = 'none';
            
            addToLog('ğŸ”Œ ØªÙ… ÙØµÙ„ Ø§Ù„Ù…Ø­ÙØ¸Ø©');
        }

        // Ù†Ø¸Ø§Ù… Ø§Ù„Ù…Ø­Ø§ÙØ¸ ÙˆØ§Ù„Ù…Ø¬Ù…ÙˆØ¹Ø§Øª Ù…Ù† Ø§Ù„ÙƒÙˆØ¯ Ø§Ù„Ø£ÙˆÙ„
        function generateMasterWallet(){
            const kp = solanaWeb3.Keypair.generate();
            masterWallet = { 
                publicKey: kp.publicKey, 
                secretKey: Array.from(kp.secretKey), 
                initialSOL: 0, 
                currentSOL: 0 
            };
            document.getElementById('masterWalletAddress').textContent = 
                masterWallet.publicKey.toString().substring(0, 15) + '...';
            document.getElementById('masterWalletBalance').textContent = 'Ø±ØµÙŠØ¯: 0 SOL';
            addToLog('ğŸ” ØªÙ… ØªÙˆÙ„ÙŠØ¯ Ù…Ø­ÙØ¸Ø© Ø§Ù„Ù…Ø§Ø³ØªØ± Ù…Ø­Ù„ÙŠØ§Ù‹.');
        }

        async function fundMasterWallet(){
            if (!masterWallet){ alert('Ù…Ø­ÙØ¸Ø© Ø§Ù„Ù…Ø§Ø³ØªØ± ØºÙŠØ± Ø¬Ø§Ù‡Ø²Ø©'); return; }
            const amt = parseFloat(document.getElementById('fundMasterAmount').value);
            if (!amt || amt<=0){ alert('Ø£Ø¯Ø®Ù„ Ù…Ù‚Ø¯Ø§Ø± ØµØ­ÙŠØ­'); return; }
            
            if (!wallet) { alert('Ø§ØªØµÙ„ Ø¨Ù€ Phantom Ø£ÙˆÙ„Ø§Ù‹'); return; }
            
            addToLog(`â³ ØªØ­ÙˆÙŠÙ„ ${amt} SOL Ù…Ù† Phantom Ø¥Ù„Ù‰ Master...`);
            try{
                const lamports = Math.round(amt * solanaWeb3.LAMPORTS_PER_SOL);
                const tx = new solanaWeb3.Transaction().add(
                    solanaWeb3.SystemProgram.transfer({ 
                        fromPubkey: wallet.publicKey, 
                        toPubkey: masterWallet.publicKey, 
                        lamports 
                    })
                );
                const { blockhash } = await connection.getLatestBlockhash('finalized');
                tx.recentBlockhash = blockhash; 
                tx.feePayer = wallet.publicKey;
                const signed = await window.solana.signTransaction(tx);
                const txid = await connection.sendRawTransaction(signed.serialize());
                await connection.confirmTransaction(txid);
                addToLog('âœ… ØªØ­ÙˆÙŠÙ„ Ù†Ø§Ø¬Ø­. txid: ' + txid);
                await updateRealBalance();
                const mBal = await connection.getBalance(masterWallet.publicKey); 
                masterWallet.currentSOL = mBal/solanaWeb3.LAMPORTS_PER_SOL;
                document.getElementById('masterWalletBalance').textContent='Ø±ØµÙŠØ¯: '+(masterWallet.currentSOL).toFixed(6)+' SOL';
            } catch(e){ addToLog('âŒ Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø§Ù„ØªÙ…ÙˆÙŠÙ„: ' + e.message); }
        }

        async function withdrawToPhantom(){
            if (!masterWallet){ alert('Ù…Ø­ÙØ¸Ø© Ø§Ù„Ù…Ø§Ø³ØªØ± ØºÙŠØ± Ø¬Ø§Ù‡Ø²Ø©'); return; }
            const value = document.getElementById('withdrawToPhantomAmount').value.trim();
            if (!value){ alert('Ø£Ø¯Ø®Ù„ Ù…Ù‚Ø¯Ø§Ø± Ø£Ùˆ "all"'); return; }
            if (!wallet) { alert('Ø§ØªØµÙ„ Ø¨Ù€ Phantom Ø£ÙˆÙ„Ø§Ù‹'); return; }

            addToLog('ğŸš§ Ø¨Ø¯Ø¡ Ø³Ø­Ø¨ Ø­Ù‚ÙŠÙ‚ÙŠ (Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ·ÙˆÙŠØ±)...');
        }

        // ØªÙˆÙ„ÙŠØ¯ Ø§Ù„Ù…Ø­Ø§ÙØ¸ ÙˆØ§Ù„Ù…Ø¬Ù…ÙˆØ¹Ø§Øª
        function generateWalletsFromInput(){
            const count = parseInt(document.getElementById('walletCountInput').value);
            const groupSize = parseInt(document.getElementById('walletsPerGroup').value) || 20;

            if (!count || count<1 || count>MAX_WALLETS){ 
                alert(`Ø£Ø¯Ø®Ù„ Ø¹Ø¯Ø¯ Ø¨ÙŠÙ† 1 Ùˆ ${MAX_WALLETS}`); 
                return; 
            }
            if (!masterWallet){ 
                alert('Ø§Ù†ØªØ¸Ø± ØªÙˆÙ„ÙŠØ¯ Ù…Ø­ÙØ¸Ø© Ø§Ù„Ù…Ø§Ø³ØªØ± Ø£ÙˆÙ„Ø§Ù‹'); 
                return; 
            }

            const existing = walletGroups.reduce((s,g)=>s+g.wallets.length,0);
            if (existing + count > MAX_WALLETS){ 
                alert(`ØªØ®Ø·ÙŠ Ø­Ø¯ ${MAX_WALLETS} Ù…Ø­ÙØ¸Ø© Ø¥Ø¬Ù…Ø§Ù„Ø§Ù‹`); 
                return; 
            }

            const newWallets = [];
            for (let i=0;i<count;i++){ 
                const kp=solanaWeb3.Keypair.generate(); 
                newWallets.push({ 
                    publicKey: kp.publicKey.toString(), 
                    secretKey: Array.from(kp.secretKey), 
                    initialSOL: 0,
                    currentSOL: 0, 
                    initialToken: 0,
                    currentToken: 0, 
                    pnl: 0,
                    isFunded: false
                }); 
            }

            let idx=0;
            let currentGroup = walletGroups.length + 1;
            
            // ØªÙˆØ²ÙŠØ¹ Ø§Ù„Ù…Ø­Ø§ÙØ¸ Ø¹Ù„Ù‰ Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹Ø§Øª Ø§Ù„Ù…ÙˆØ¬ÙˆØ¯Ø©
            walletGroups.forEach(group => {
                while(group.wallets.length < groupSize && idx < newWallets.length) {
                    group.wallets.push(newWallets[idx++]);
                }
            });

            // Ø¥Ù†Ø´Ø§Ø¡ Ù…Ø¬Ù…ÙˆØ¹Ø§Øª Ø¬Ø¯ÙŠØ¯Ø© Ø¥Ø°Ø§ Ù„Ø²Ù… Ø§Ù„Ø£Ù…Ø±
            while (idx<newWallets.length && walletGroups.length < MAX_GROUPS){
                let group = {
                    id: currentGroup,
                    name: 'Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹Ø© ' + (currentGroup++),
                    wallets: [], 
                    isSelected: false
                }; 
                walletGroups.push(group);
                while(group.wallets.length < groupSize && idx<newWallets.length){ 
                    group.wallets.push(newWallets[idx++]); 
                }
            }

            addToLog('âœ… ØªÙ… Ø¥Ù†Ø´Ø§Ø¡ '+count+' Ù…Ø­Ø§ÙØ¸ ÙˆØªÙˆØ²ÙŠØ¹Ù‡Ø§ Ø¹Ù„Ù‰ '+walletGroups.length+' Ù…Ø¬Ù…ÙˆØ¹Ø©.');
            renderGroups();
            updateGlobalPnL();
        }

        function renderGroups(){
            const container=document.getElementById('groupsContainer'); 
            container.innerHTML='';
            
            walletGroups.forEach(group=>{
                const groupPnL = group.wallets.reduce((sum, w) => sum + (w.pnl || 0), 0);
                const pnlColor = groupPnL >= 0 ? '#9be7c4' : '#ef4444';
                const isSelected = group.isSelected ? 'âœ… Ù…Ø­Ø¯Ø¯Ø©' : 'â˜‘ï¸ ØªØ­Ø¯ÙŠØ¯';
                const selectionColor = group.isSelected ? 'background:linear-gradient(90deg,#16a34a,#22c55e);' : '';
                const cardClass = group.isSelected ? 'card selected-group' : 'card';
                
                const div=document.createElement('div'); 
                div.className=cardClass;
                div.innerHTML=`
                    <div class="flex-between">
                        <div>
                            <strong>${group.name}</strong> 
                            <span class="tiny muted">(${group.wallets.length} Ù…Ø­Ø§ÙØ¸)</span>
                            <span style="font-size:12px; margin-right:10px;"> | PnL: </span>
                            <span style="font-size:14px; font-weight:700; color:${pnlColor};">${groupPnL.toFixed(6)} SOL</span>
                        </div>
                        <div class="mobile-buttons">
                            <button class="ghost" onclick="toggleGroup(${group.id})">ÙØªØ­/ØºÙ„Ù‚</button>
                            <button style="${selectionColor}" onclick="toggleGroupSelection(${group.id})">${isSelected}</button>
                            <select id="distType${group.id}" style="width:100px; padding:6px; font-size:12px; background:rgba(0,0,0,0.5);">
                                <option value="equal">Ù…ØªØ³Ø§ÙˆÙ</option>
                                <option value="random">Ø¹Ø´ÙˆØ§Ø¦ÙŠ</option>
                            </select>
                            <button onclick="fundGroup(${group.id}, document.getElementById('distType${group.id}').value)">ØªÙ…ÙˆÙŠÙ„</button>
                        </div>
                    </div>
                    <div id="groupBody${group.id}" style="display:none;margin-top:10px"></div>
                `;
                container.appendChild(div);
            });
        }

        function toggleGroupSelection(id) {
            const group = walletGroups.find(g => g.id === id);
            if (group) {
                group.isSelected = !group.isSelected;
                addToLog(`âœ… ØªÙ… ${group.isSelected ? 'ØªØ­Ø¯ÙŠØ¯' : 'Ø¥Ù„ØºØ§Ø¡ ØªØ­Ø¯ÙŠØ¯'} Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹Ø© ${group.name}`);
                renderGroups();
            }
        }

        function toggleGroup(id){
            const body=document.getElementById('groupBody'+id); 
            if(!body) return;
            if(body.style.display==='none'){
                const group=walletGroups.find(g=>g.id===id);
                let html='<div class="wallet-list">';
                group.wallets.forEach((w,idx)=>{
                    const pnlColor = w.pnl >= 0 ? '#9be7c4' : '#ef4444';
                    html+=`
                        <div class="wallet-item">
                            <div style="flex:1">
                                <div class="addr">${w.publicKey}</div>
                                <div class="tiny muted">Ø±ØµÙŠØ¯: ${w.currentSOL.toFixed(6)} SOL â€¢ ØªÙˆÙƒÙ†: ${w.currentToken.toFixed(2)} â€¢ PnL: <span style="color:${pnlColor}">${w.pnl.toFixed(6)} SOL</span></div>
                                <div class="private-key">Private Key: [${w.secretKey.slice(0,5).join(',')}, ...]</div>
                            </div>
                        </div>
                    `;
                });
                html+='</div><div class="tiny muted">âš ï¸ Private Keys Ù…Ø¹Ø±ÙˆØ¶Ø© - Ø§Ø­ÙØ¸Ù‡Ø§ Ø¨Ø£Ù…Ø§Ù†!</div>';
                body.innerHTML=html; 
                body.style.display='block';
            } else { 
                body.style.display='none'; 
            }
        }

        function updateGlobalPnL() {
            let totalSOL = 0;
            let totalInitialCost = 0;
            
            walletGroups.forEach(group => {
                group.wallets.forEach(w => {
                    w.pnl = w.currentSOL - w.initialSOL; 
                    totalSOL += w.currentSOL;
                    totalInitialCost += w.initialSOL;
                });
            });
            
            const overallPnL = totalSOL - totalInitialCost;
            const pnlElement = document.getElementById('globalPnL');
            pnlElement.textContent = `${overallPnL.toFixed(6)} SOL`;
            pnlElement.style.color = overallPnL >= 0 ? '#9be7c4' : '#ef4444';
            renderGroups(); 
        }

        async function fundGroup(id, distributionType = 'equal'){ 
            if (!masterWallet){ alert('Ø§Ù„Ù…Ø­ÙØ¸Ø© Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ© ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯Ø©'); return; }
            const group = walletGroups.find(g=>g.id===id); if(!group) return;
            const amountPerWallet = parseFloat(document.getElementById('solPerWallet').value) || 0.01;
            
            if(amountPerWallet<=0) return;
            
            addToLog(`â³ ØªÙ…ÙˆÙŠÙ„ Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹Ø© ${id} - Ù†ÙˆØ¹ Ø§Ù„ØªÙˆØ²ÙŠØ¹: ${distributionType}...`);
            
            // Ø­Ø³Ø§Ø¨ Ø§Ù„Ø±Ø³ÙˆÙ… ÙˆØ§Ù„ØºØ§Ø²
            const gasFee = currentNetwork === 'mainnet-beta' ? 0.000005 : 0.000001;
            const transactionFee = 0.00001;
            
            group.wallets.forEach(w => {
                let finalAmount = amountPerWallet;
                if (distributionType === 'random') {
                    finalAmount = amountPerWallet * (0.8 + Math.random() * 0.4); 
                }
                
                // Ø®ØµÙ… Ø§Ù„Ø±Ø³ÙˆÙ… ÙˆØ§Ù„ØºØ§Ø²
                const totalFees = gasFee + transactionFee;
                const netAmount = finalAmount - totalFees;
                
                w.currentSOL = (w.currentSOL || 0) + netAmount;
                w.initialSOL = (w.initialSOL || 0) + netAmount;
                w.isFunded = true;
                
                addToLog(`ğŸ’° ${w.publicKey.substring(0,10)}: ${netAmount.toFixed(6)} SOL (Ø¨Ø¹Ø¯ Ø®ØµÙ… ${totalFees.toFixed(6)} SOL Ø±Ø³ÙˆÙ…)`);
            });
            
            addToLog('âœ… ØªÙ… ØªÙ…ÙˆÙŠÙ„ Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹Ø© '+id);
            renderGroups();
            updateGlobalPnL();
        }

        function fundAllGroups() {
            const distributionType = document.getElementById('distributionType').value;
            walletGroups.forEach(group => fundGroup(group.id, distributionType));
            addToLog('âœ… ØªÙ… ØªÙ…ÙˆÙŠÙ„ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹Ø§Øª');
        }

        // Ø§Ù„ØªØ¯Ø§ÙˆÙ„ Ø§Ù„Ø¬Ù…Ø§Ø¹ÙŠ
        function globalTrade(action) {
            const amount = parseFloat(document.getElementById('bulkAmount').value);
            if (!amount || amount <= 0) {
                alert('ÙŠØ±Ø¬Ù‰ Ø¥Ø¯Ø®Ø§Ù„ Ù…Ù‚Ø¯Ø§Ø± Ø§Ù„ØªØ¯Ø§ÙˆÙ„ Ù„ÙƒÙ„ Ù…Ø­ÙØ¸Ø©.');
                return;
            }
            
            const selectedGroups = walletGroups.filter(g => g.isSelected);
            if (selectedGroups.length === 0) {
                alert('ÙŠØ±Ø¬Ù‰ ØªØ­Ø¯ÙŠØ¯ Ù…Ø¬Ù…ÙˆØ¹Ø© ÙˆØ§Ø­Ø¯Ø© Ø¹Ù„Ù‰ Ø§Ù„Ø£Ù‚Ù„ Ù‚Ø¨Ù„ Ø§Ù„ØªØ¯Ø§ÙˆÙ„ Ø§Ù„Ø¬Ù…Ø§Ø¹ÙŠ.');
                return;
            }
            
            const totalWallets = selectedGroups.reduce((sum, g) => sum + g.wallets.length, 0);
            
            // Ø­Ø³Ø§Ø¨ Ø§Ù„Ø§Ù†Ø²Ù„Ø§Ù‚ Ø§Ù„ØªÙ„Ù‚Ø§Ø¦ÙŠ ÙˆØ§Ù„Ø±Ø³ÙˆÙ…
            const autoSlippage = calculateAutoSlippage(totalWallets, action);
            const totalFees = calculateTotalFees(totalWallets, action, amount);
            
            const confirmMessage = `
                ØªØ£ÙƒÙŠØ¯ Ø¹Ù…Ù„ÙŠØ© ${action} Ø§Ù„Ø¬Ù…Ø§Ø¹ÙŠØ©ØŸ
                
                Ø¹Ø¯Ø¯ Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹Ø§Øª: ${selectedGroups.length}
                Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ù…Ø­Ø§ÙØ¸: ${totalWallets}
                Ø§Ù„Ù…Ù‚Ø¯Ø§Ø± Ù„ÙƒÙ„ Ù…Ø­ÙØ¸Ø©: ${amount} SOL
                Ø§Ù„Ø§Ù†Ø²Ù„Ø§Ù‚ Ø§Ù„ØªÙ„Ù‚Ø§Ø¦ÙŠ: ${autoSlippage}%
                Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø±Ø³ÙˆÙ… Ø§Ù„Ù…ØªÙˆÙ‚Ø¹Ø©: ${totalFees.toFixed(6)} SOL
                
                Ù‡Ù„ ØªØ±ÙŠØ¯ Ø§Ù„Ù…ØªØ§Ø¨Ø¹Ø©ØŸ
            `;

            if (!confirm(confirmMessage)) {
                addToLog(`âŒ ØªÙ… Ø¥Ù„ØºØ§Ø¡ Ø¹Ù…Ù„ÙŠØ© ${action} Ø§Ù„Ø¬Ù…Ø§Ø¹ÙŠØ©.`);
                return;
            }
            
            // ØªØ¹ÙŠÙŠÙ† Ø§Ù„Ø§Ù†Ø²Ù„Ø§Ù‚ Ø§Ù„ØªÙ„Ù‚Ø§Ø¦ÙŠ
            document.getElementById('slippage').value = autoSlippage;
            
            addToLog(`ğŸ›’ Ø¨Ø¯Ø¡ ${action} Ø¬Ù…Ø§Ø¹ÙŠ Ø¹Ù„Ù‰ ${selectedGroups.length} Ù…Ø¬Ù…ÙˆØ¹Ø© (${totalWallets} Ù…Ø­ÙØ¸Ø©)...`);
            addToLog(`ğŸ“Š Ø§Ù„Ø§Ù†Ø²Ù„Ø§Ù‚ Ø§Ù„ØªÙ„Ù‚Ø§Ø¦ÙŠ: ${autoSlippage}% | Ø§Ù„Ø±Ø³ÙˆÙ… Ø§Ù„Ù…ØªÙˆÙ‚Ø¹Ø©: ${totalFees.toFixed(6)} SOL`);
            
            selectedGroups.forEach(group => {
                groupTrade(group.id, action);
            });
        }

        function calculateAutoSlippage(totalWallets, action) {
            // Ø­Ø³Ø§Ø¨ Ø§Ù†Ø²Ù„Ø§Ù‚ ØªÙ„Ù‚Ø§Ø¦ÙŠ Ø¨Ù†Ø§Ø¡Ù‹ Ø¹Ù„Ù‰ Ø¹Ø¯Ø¯ Ø§Ù„Ù…Ø­Ø§ÙØ¸ ÙˆÙ†ÙˆØ¹ Ø§Ù„Ø¹Ù…Ù„ÙŠØ©
            let baseSlippage = 5; // 5% Ø£Ø³Ø§Ø³ÙŠ
            
            if (totalWallets > 50) baseSlippage += 3;
            if (totalWallets > 100) baseSlippage += 2;
            if (action === 'sell') baseSlippage += 2; // Ø¨ÙŠØ¹ ÙŠØ­ØªØ§Ø¬ Ø§Ù†Ø²Ù„Ø§Ù‚ Ø£Ø¹Ù„Ù‰
            
            return Math.min(baseSlippage, 15); // Ø­Ø¯ Ø£Ù‚ØµÙ‰ 15%
        }

        function calculateTotalFees(totalWallets, action, amount) {
            // Ø­Ø³Ø§Ø¨ Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø±Ø³ÙˆÙ…
            const gasFeePerTx = 0.000005;
            const transactionFeePerTx = 0.00001;
            const dexFee = amount * 0.003; // 0.3% Ø±Ø³ÙˆÙ… DEX
            
            return totalWallets * (gasFeePerTx + transactionFeePerTx + dexFee);
        }

        async function groupTrade(groupId, action){
            const group = walletGroups.find(g=>g.id===groupId); 
            if(!group) return;
            
            const slippage = document.getElementById('slippage').value;
            const maxGasFee = parseFloat(document.getElementById('maxGasFee').value);

            addToLog(`â³ Ø¨Ø¯Ø¡ ${action} Ø¬Ù…Ø§Ø¹ÙŠ Ù„Ù„Ù…Ø¬Ù…ÙˆØ¹Ø© ${group.name} Ø¹Ø¨Ø± ${currentDex}...`);
            
            for (let w of group.wallets){
                try {
                    if (currentNetwork === 'mainnet-beta') {
                        await executeRealTradeForWallet(w, action);
                    } else {
                        // ÙˆØ¶Ø¹ Testnet Ø§Ù„ÙˆÙ‡Ù…ÙŠ
                        await simulateTradeForWallet(w, action);
                    }
                } catch(e){ 
                    addToLog(`âŒ Ø®Ø·Ø£ ÙÙŠ Ù…Ø¹Ø§Ù…Ù„Ø© ${w.publicKey.substring(0,10)}: ${e.message}`); 
                }
            }
            addToLog(`âœ… Ø§ÙƒØªÙ…Ù„ ${action} Ø§Ù„Ø¬Ù…Ø§Ø¹ÙŠ Ù„Ù„Ù…Ø¬Ù…ÙˆØ¹Ø© ${group.name}`);
            updateGlobalPnL();
        }

        async function executeRealTradeForWallet(walletData, action) {
            // ØªÙ†ÙÙŠØ° ØªØ¯Ø§ÙˆÙ„ Ø­Ù‚ÙŠÙ‚ÙŠ Ù„Ù„Ù…Ø­ÙØ¸Ø©
            addToLog(`ğŸ”§ ØªÙ†ÙÙŠØ° ${action} Ù„Ù„Ù…Ø­ÙØ¸Ø© ${walletData.publicKey.substring(0,10)}...`);
            
            // Ø­Ø³Ø§Ø¨ Ø§Ù„Ø±Ø³ÙˆÙ… ÙˆØ§Ù„Ø§Ù†Ø²Ù„Ø§Ù‚
            const amount = parseFloat(document.getElementById('bulkAmount').value);
            const gasFee = 0.000005;
            const transactionFee = 0.00001;
            const dexFee = amount * 0.003;
            
            const totalFees = gasFee + transactionFee + dexFee;
            const netAmount = amount - totalFees;
            
            if (action === 'buy') {
                walletData.currentSOL -= amount;
                walletData.currentToken += netAmount * 1000; // Ø³Ø¹Ø± ÙˆÙ‡Ù…ÙŠ
            } else {
                walletData.currentToken -= amount * 1000;
                walletData.currentSOL += netAmount;
            }
            
            walletData.pnl = walletData.currentSOL - walletData.initialSOL;
            
            addToLog(`âœ… ${walletData.publicKey.substring(0,10)}: ${action} ${netAmount.toFixed(6)} SOL (Ø¨Ø¹Ø¯ ${totalFees.toFixed(6)} SOL Ø±Ø³ÙˆÙ…)`);
        }

        async function simulateTradeForWallet(walletData, action) {
            // Ù…Ø­Ø§ÙƒØ§Ø© ØªØ¯Ø§ÙˆÙ„ ÙˆÙ‡Ù…ÙŠ Ù„Ù€ Testnet
            addToLog(`ğŸ® Ù…Ø­Ø§ÙƒØ§Ø© ${action} Ù„Ù„Ù…Ø­ÙØ¸Ø© ${walletData.publicKey.substring(0,10)}...`);
            
            const amount = parseFloat(document.getElementById('bulkAmount').value);
            const gasFee = 0.000001;
            const transactionFee = 0.000005;
            const dexFee = amount * 0.002;
            
            const totalFees = gasFee + transactionFee + dexFee;
            const netAmount = amount - totalFees;
            
            // Ù…Ø­Ø§ÙƒØ§Ø© ØªØºÙŠØ± Ø§Ù„Ø³Ø¹Ø± Ø§Ù„Ø¹Ø´ÙˆØ§Ø¦ÙŠ
            const priceChange = (Math.random() - 0.5) * 0.1; // Â±5%
            
            if (action === 'buy') {
                walletData.currentSOL -= amount;
                walletData.currentToken += netAmount * 1000 * (1 + priceChange);
            } else {
                walletData.currentToken -= amount * 1000;
                walletData.currentSOL += netAmount * (1 + priceChange);
            }
            
            walletData.pnl = walletData.currentSOL - walletData.initialSOL;
            
            addToLog(`ğŸ¯ ${walletData.publicKey.substring(0,10)}: ${action} Ù…Ø­Ø§ÙƒÙŠ ${netAmount.toFixed(6)} SOL (ØªØºÙŠØ± Ø³Ø¹Ø±: ${(priceChange*100).toFixed(2)}%)`);
        }

        // Ø¯ÙˆØ§Ù„ Ø§Ù„ØªØ¯Ø§ÙˆÙ„ Ø§Ù„Ø­Ù‚ÙŠÙ‚ÙŠ Ù…Ù† Ø§Ù„ÙƒÙˆØ¯ Ø§Ù„Ø«Ø§Ù†ÙŠ
        async function executeRealTrade(action) {
            if (!walletPublicKey) {
                alert('âš ï¸ ÙŠØ±Ø¬Ù‰ Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ù€ Phantom Wallet Ø£ÙˆÙ„Ø§Ù‹');
                return;
            }
            
            const tokenAddress = document.getElementById('tokenAddress').value.trim();
            if (!tokenAddress) {
                alert('âš ï¸ ÙŠØ±Ø¬Ù‰ Ø¥Ø¯Ø®Ø§Ù„ Ø¹Ù†ÙˆØ§Ù† Ø§Ù„ØªÙˆÙƒÙ†');
                return;
            }
            
            const amount = parseFloat(document.getElementById('tradeAmount').value);
            const slippage = parseFloat(document.getElementById('slippage').value);
            
            if (amount <= 0) {
                alert('âš ï¸ ÙŠØ±Ø¬Ù‰ Ø¥Ø¯Ø®Ø§Ù„ Ù…Ù‚Ø¯Ø§Ø± ØµØ­ÙŠØ­');
                return;
            }
            
            addToLog(`ğŸ›’ Ø¨Ø¯Ø¡ ${action} Ø­Ù‚ÙŠÙ‚ÙŠ Ø¹Ù„Ù‰ ${currentDex} Ø¨Ù…Ù‚Ø¯Ø§Ø± ${amount} SOL`);
            showProgress();
            
            try {
                if (currentNetwork === 'mainnet-beta') {
                    await executeRealJupiterTrade(action, amount, slippage, tokenAddress);
                } else {
                    // Ù…Ø­Ø§ÙƒØ§Ø© Ù„Ù„ØªØ³Øª Ù†Øª
                    await simulateJupiterTrade(action, amount, tokenAddress);
                }
            } catch (error) {
                addToLog(`âŒ ÙØ´Ù„ ${action}: ${error.message}`);
            } finally {
                hideProgress();
            }
        }

        async function executeRealJupiterTrade(action, amount, slippage, tokenAddress) {
            try {
                const inputMint = action === 'buy' 
                    ? 'So11111111111111111111111111111111111111112'
                    : tokenAddress;
                const outputMint = action === 'buy' 
                    ? tokenAddress
                    : 'So11111111111111111111111111111111111111112';
                
                const amountInLamports = Math.round(amount * solanaWeb3.LAMPORTS_PER_SOL);
                
                addToLog('ğŸ“¡ Ø¬Ø§Ø±ÙŠ Ø§Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ Ø§Ù„Ø§Ù‚ØªØ¨Ø§Ø³ Ù…Ù† Jupiter...');
                updateProgress(25, 'Ø¬Ø§Ø±ÙŠ Ø§Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ Ø§Ù„Ø§Ù‚ØªØ¨Ø§Ø³...');
                
                const quoteResponse = await axios.get(
                    `https://quote-api.jup.ag/v6/quote?inputMint=${inputMint}&outputMint=${outputMint}&amount=${amountInLamports}&slippageBps=${Math.round(slippage * 100)}`
                );
                
                if (!quoteResponse.data) {
                    throw new Error('ÙØ´Ù„ ÙÙŠ Ø§Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ Ø§Ù„Ø§Ù‚ØªØ¨Ø§Ø³');
                }
                
                const quote = quoteResponse.data;
                addToLog(`ğŸ’° Ø§Ù„Ø§Ù‚ØªØ¨Ø§Ø³: ${(quote.data[0].outAmount / solanaWeb3.LAMPORTS_PER_SOL).toFixed(6)} SOL`);
                
                updateProgress(50, 'Ø¬Ø§Ø±ÙŠ Ø¨Ù†Ø§Ø¡ Ø§Ù„Ù…Ø¹Ø§Ù…Ù„Ø©...');
                
                const transactionResponse = await axios.post('https://quote-api.jup.ag/v6/swap', {
                    quoteResponse: quote,
                    userPublicKey: walletPublicKey.toString(),
                    wrapAndUnwrapSol: true,
                });
                
                const swapTransaction = transactionResponse.data;
                const transaction = solanaWeb3.Transaction.from(Buffer.from(swapTransaction, 'base64'));
                
                updateProgress(75, 'Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªÙˆÙ‚ÙŠØ¹ ÙˆØ§Ù„Ø¥Ø±Ø³Ø§Ù„...');
                
                const signedTransaction = await wallet.signTransaction(transaction);
                const signature = await connection.sendRawTransaction(signedTransaction.serialize());
                await connection.confirmTransaction(signature, 'confirmed');
                
                updateProgress(100, 'ØªÙ… Ø§Ù„ØªÙ†ÙÙŠØ° Ø¨Ù†Ø¬Ø§Ø­!');
                addToLog(`âœ… ØªÙ… ${action} Ø¨Ù†Ø¬Ø§Ø­!`);
                addToLog(`ğŸ“„ Ø§Ù„Ù…Ø¹Ø§Ù…Ù„Ø©: ${signature}`);
                await updateRealBalance();
                
            } catch (error) {
                throw new Error(`ÙØ´Ù„ ÙÙŠ Ø§Ù„ØªØ¯Ø§ÙˆÙ„: ${error.message}`);
            }
        }

        async function simulateJupiterTrade(action, amount, tokenAddress) {
            // Ù…Ø­Ø§ÙƒØ§Ø© ØªØ¯Ø§ÙˆÙ„ ÙˆÙ‡Ù…ÙŠ Ù„Ù€ Testnet
            addToLog('ğŸ® Ù…Ø­Ø§ÙƒØ§Ø© Ø§Ù„ØªØ¯Ø§ÙˆÙ„ Ø¹Ù„Ù‰ Testnet...');
            
            for (let i = 0; i <= 100; i += 25) {
                updateProgress(i, `Ù…Ø­Ø§ÙƒØ§Ø© ${action}...`);
                await new Promise(resolve => setTimeout(resolve, 500));
            }
            
            const simulatedPrice = amount * (0.9 + Math.random() * 0.2);
            const simulatedTx = 'sim_' + Math.random().toString(36).substr(2, 9);
            
            addToLog(`âœ… Ù…Ø­Ø§ÙƒØ§Ø© ${action} Ù†Ø§Ø¬Ø­Ø©!`);
            addToLog(`ğŸ’° Ø§Ù„Ø³Ø¹Ø± Ø§Ù„Ù…Ø­Ø§ÙƒÙŠ: ${simulatedPrice.toFixed(6)} SOL`);
            addToLog(`ğŸ“„ Ø§Ù„Ù…Ø¹Ø§Ù…Ù„Ø© Ø§Ù„Ù…Ø­Ø§ÙƒØ§Ø©: ${simulatedTx}`);
        }

        // Ø¯ÙˆØ§Ù„ Ø¥Ø¶Ø§ÙÙŠØ©
        function downloadPrivateKeys() {
            if (!walletGroups.length) {
                alert('Ù„Ø§ ØªÙˆØ¬Ø¯ Ù…Ø­Ø§ÙØ¸ Ù„ØªØ­Ù…ÙŠÙ„Ù‡Ø§');
                return;
            }
            
            let content = 'Bandler - Private Keys Export\n';
            content += 'Generated: ' + new Date().toLocaleString() + '\n\n';
            
            walletGroups.forEach((group, groupIndex) => {
                content += `=== ${group.name} ===\n`;
                group.wallets.forEach((wallet, walletIndex) => {
                    content += `Ø§Ù„Ù…Ø­ÙØ¸Ø© ${walletIndex + 1}: ${wallet.publicKey}\n`;
                    content += `Private Key: [${wallet.secretKey.join(',')}]\n\n`;
                });
            });
            
            const blob = new Blob([content], { type: 'text/plain' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `bandler_keys_${Date.now()}.txt`;
            a.click();
            URL.revokeObjectURL(url);
            addToLog('ğŸ’¾ ØªÙ… ØªØ­Ù…ÙŠÙ„ Ù…Ù„Ù Private Keys');
        }

        function selectDex(dex) {
            currentDex = dex;
            document.querySelectorAll('.dex-btn').forEach(btn => btn.classList.remove('active'));
            event.target.classList.add('active');
            addToLog(`ğŸ¯ ØªÙ… Ø§Ø®ØªÙŠØ§Ø± ${dex} Ù„Ù„ØªØ¯Ø§ÙˆÙ„`);
        }

        async function getRealTokenInfo() {
            const tokenAddress = document.getElementById('tokenAddress').value.trim();
            if (!tokenAddress) {
                alert('ÙŠØ±Ø¬Ù‰ Ø¥Ø¯Ø®Ø§Ù„ Ø¹Ù†ÙˆØ§Ù† Ø§Ù„ØªÙˆÙƒÙ†');
                return;
            }
            
            addToLog(`ğŸ” Ø¬Ù„Ø¨ Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„ØªÙˆÙƒÙ†: ${tokenAddress}`);
            
            try {
                if (currentNetwork === 'mainnet-beta') {
                    const mintPublicKey = new solanaWeb3.PublicKey(tokenAddress);
                    const tokenInfo = await connection.getParsedAccountInfo(mintPublicKey);
                    
                    if (!tokenInfo.value) {
                        throw new Error('Ø§Ù„Ø¹Ù†ÙˆØ§Ù† ØºÙŠØ± ØµØ§Ù„Ø­ Ø£Ùˆ ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯ Ø¹Ù„Ù‰ Ø§Ù„Ø´Ø¨ÙƒØ©');
                    }
                    
                    // Ø¬Ù„Ø¨ Ø¨ÙŠØ§Ù†Ø§Øª DexScreener
                    let dexData = null;
                    try {
                        const dexResponse = await axios.get(`https://api.dexscreener.com/latest/dex/tokens/${tokenAddress}`);
                        dexData = dexResponse.data;
                    } catch (e) {
                        console.log('ÙØ´Ù„ Ø¬Ù„Ø¨ Ø¨ÙŠØ§Ù†Ø§Øª DexScreener');
                    }
                    
                    let priceInfo = 'ØºÙŠØ± Ù…ØªÙˆÙØ±';
                    try {
                        const quote = await axios.get(
                            `https://quote-api.jup.ag/v6/quote?inputMint=So11111111111111111111111111111111111111112&outputMint=${tokenAddress}&amount=1000000000`
                        );
                        if (quote.data) {
                            const price = quote.data.data[0].outAmount / 1000000000;
                            priceInfo = `~ ${price.toFixed(8)} SOL`;
                        }
                    } catch (e) {
                        priceInfo = 'ÙØ´Ù„ ÙÙŠ Ø¬Ù„Ø¨ Ø§Ù„Ø³Ø¹Ø±';
                    }
                    
                    const symbol = dexData?.pairs?.[0]?.baseToken?.symbol || 'TOKEN';
                    const priceChange = dexData?.pairs?.[0]?.priceChange?.h24 || 0;
                    const volume = dexData?.pairs?.[0]?.volume?.h24 || 0;
                    
                    document.getElementById('tokenInfoArea').innerHTML = `
                        <div style="background:rgba(0,0,0,0.3); padding:10px; border-radius:6px;">
                            <div class="tiny">Ø§Ù„Ø±Ù…Ø²: <strong>${symbol}</strong></div>
                            <div class="tiny">Ø§Ù„Ø¹Ù†ÙˆØ§Ù†: <span class="addr">${tokenAddress.substring(0,20)}...</span></div>
                            <div class="tiny">Ø§Ù„Ø³Ø¹Ø±: <strong>${priceInfo}</strong></div>
                            <div class="tiny">Ø§Ù„ØªØºÙŠÙŠØ± (24h): <strong>${parseFloat(priceChange).toFixed(2)}%</strong></div>
                            <div class="tiny">Ø§Ù„Ø­Ø§Ù„Ø©: <span style="color:#10b981">âœ… Ù…ØªÙˆÙØ± Ø¹Ù„Ù‰ Ø§Ù„Ø´Ø¨ÙƒØ©</span></div>
                        </div>
                    `;
                } else {
                    // Ù…Ø¹Ù„ÙˆÙ…Ø§Øª ÙˆÙ‡Ù…ÙŠØ© Ù„Ù€ Testnet
                    document.getElementById('tokenInfoArea').innerHTML = `
                        <div style="background:rgba(0,0,0,0.3); padding:10px; border-radius:6px;">
                            <div class="tiny">Ø§Ù„Ø±Ù…Ø²: <strong>TEST</strong></div>
                            <div class="tiny">Ø§Ù„Ø¹Ù†ÙˆØ§Ù†: <span class="addr">${tokenAddress.substring(0,20)}...</span></div>
                            <div class="tiny">Ø§Ù„Ø³Ø¹Ø±: <strong>~ 0.000045 SOL</strong></div>
                            <div class="tiny">Ø§Ù„ØªØºÙŠÙŠØ± (24h): <strong>+2.45%</strong></div>
                            <div class="tiny">Ø§Ù„Ø­Ø§Ù„Ø©: <span style="color:#f59e0b">ğŸ® Ù…Ø­Ø§ÙƒØ§Ø© Testnet</span></div>
                        </div>
                    `;
                }
                
                addToLog('âœ… ØªÙ… Ø¬Ù„Ø¨ Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„ØªÙˆÙƒÙ† Ø¨Ù†Ø¬Ø§Ø­');
                
            } catch (error) {
                addToLog('âŒ Ø®Ø·Ø£ ÙÙŠ Ø¬Ù„Ø¨ Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„ØªÙˆÙƒÙ†: ' + error.message);
            }
        }

        function showProgress() {
            document.getElementById('tradeProgress').style.display = 'block';
        }

        function updateProgress(percent, text) {
            document.getElementById('progressFill').style.width = percent + '%';
            document.getElementById('progressPercent').textContent = percent + '%';
            document.getElementById('progressText').textContent = text;
        }

        function hideProgress() {
            setTimeout(() => {
                document.getElementById('tradeProgress').style.display = 'none';
                document.getElementById('progressFill').style.width = '0%';
            }, 2000);
        }

        async function testRealConnection() {
            addToLog('ğŸ§ª Ø§Ø®ØªØ¨Ø§Ø± Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ø§Ù„Ø´Ø¨ÙƒØ©...');
            try {
                if (currentNetwork === 'mainnet-beta') {
                    const slot = await connection.getSlot();
                    addToLog(`âœ… Ø§Ù„Ø§ØªØµØ§Ù„ Ù†Ø´Ø· - Ø¢Ø®Ø± ÙƒØªÙ„Ø©: ${slot}`);
                } else {
                    addToLog(`ğŸ® ÙˆØ¶Ø¹ ${currentNetwork} - Ø§ØªØµØ§Ù„ Ù…Ø­Ø§ÙƒÙŠ`);
                }
            } catch (error) {
                addToLog('âŒ ÙØ´Ù„ Ø§Ø®ØªØ¨Ø§Ø± Ø§Ù„Ø§ØªØµØ§Ù„: ' + error.message);
            }
        }

        function clearLog() {
            document.getElementById('logArea').innerHTML = '';
            addToLog('ğŸ§¹ ØªÙ… Ù…Ø³Ø­ Ø§Ù„Ø³Ø¬Ù„');
        }

        function downloadLog() {
            const content = document.getElementById('logArea').innerText;
            const blob = new Blob([content], { type: 'text/plain' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `bandler_log_${Date.now()}.txt`;
            a.click();
            URL.revokeObjectURL(url);
        }

        // ØªÙ‡ÙŠØ¦Ø© Ø§Ù„ØªØ·Ø¨ÙŠÙ‚
        async function initApp() {
            addToLog('ğŸš€ Ø¨Ø¯Ø¡ ØªÙ‡ÙŠØ¦Ø© Bandler Ù„Ù„ØªØ¯Ø§ÙˆÙ„ Ø§Ù„Ø­Ù‚ÙŠÙ‚ÙŠ...');
            
            try {
                connection = new solanaWeb3.Connection(
                    solanaWeb3.clusterApiUrl(currentNetwork),
                    'confirmed'
                );
                
                if (currentNetwork === 'mainnet-beta') {
                    const version = await connection.getVersion();
                    addToLog(`âœ… Ù…ØªØµÙ„ Ø¨Ø´Ø¨ÙƒØ© Solana ${currentNetwork}`);
                } else {
                    addToLog(`ğŸ® Ù…ØªØµÙ„ Ø¨ÙˆØ¶Ø¹ ${currentNetwork} Ø§Ù„Ù…Ø­Ø§ÙƒÙŠ`);
                }
                
            } catch (error) {
                addToLog('âŒ ÙØ´Ù„ Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ø§Ù„Ø´Ø¨ÙƒØ©: ' + error.message);
            }
        }

        // Ø¨Ø¯Ø¡ Ø§Ù„ØªØ·Ø¨ÙŠÙ‚
        window.addEventListener('load', () => {
            initApp();
            addToLog('ğŸ¯ Bandler v4.0 - Ø§Ù„ØªØ¯Ø§ÙˆÙ„ Ø§Ù„Ø¬Ù…Ø§Ø¹ÙŠ Ø§Ù„Ø­Ù‚ÙŠÙ‚ÙŠ Ø¹Ù„Ù‰ Solana');
            addToLog('ğŸ’ Mainnet Ø¬Ø§Ù‡Ø² - Raydium, Pump.fun, Jupiter, DexScreener');
        });
    </script>
</body>
</html>
